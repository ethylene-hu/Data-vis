<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8">
  <title>æ™ºèƒ½åº—é“ºåŠ©æ‰‹</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    html, body {
      height: 100%;
      overflow: hidden; /* ç¦æ­¢é¡µé¢çº§åˆ«çš„æ»šåŠ¨ */
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei', 'Helvetica Neue', Arial, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      height: 100vh; /* ä½¿ç”¨è§†å£é«˜åº¦ */
      display: flex;
      flex-direction: column;
    }

    .header {
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(10px);
      padding: 20px;
      text-align: center;
      box-shadow: 0 2px 20px rgba(0, 0, 0, 0.1);
      border-bottom: 1px solid rgba(255, 255, 255, 0.2);
    }

    .header h1 {
      color: #2c3e50;
      font-size: 28px;
      font-weight: 600;
      margin-bottom: 8px;
    }

    .header p {
      color: #7f8c8d;
      font-size: 14px;
    }

    .main-content {
      flex: 1;
      display: flex;
      max-width: none; /* ç§»é™¤æœ€å¤§å®½åº¦é™åˆ¶ï¼Œå¡«æ»¡æ•´ä¸ªå±å¹• */
      margin: 0;
      width: 100%;
      padding: 20px;
      padding-left: 340px; /* åªä¸ºå·¦ä¾§è¾¹æ ç•™å‡ºç©ºé—´ */
      padding-right: 320px; /* ä¸ºå³ä¾§è¾¹æ ç•™å‡ºç©ºé—´ */
      gap: 0; /* ç§»é™¤é—´è·ï¼Œè®©å¯¹è¯æ¡†æ›´å®½ */
    }

    .sidebar {
      width: 300px;
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(10px);
      border-radius: 20px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
      border: 1px solid rgba(255, 255, 255, 0.2);
      display: flex;
      flex-direction: column;
      position: fixed;
      top: 140px;
      left: 20px; /* æ¢å¤åˆ°åŸå§‹ä½ç½® */
      bottom: 20px;
      max-height: calc(100vh - 160px);
      z-index: 100;
    }

    .sidebar-header {
      padding: 20px;
      border-bottom: 1px solid rgba(0, 0, 0, 0.1);
      text-align: center;
    }

    .sidebar-title {
      font-weight: 600;
      font-size: 16px;
      color: #2c3e50;
      margin-bottom: 8px;
    }

    .sidebar-subtitle {
      font-size: 12px;
      color: #7f8c8d;
    }

    .chat-container {
      flex: 1;
      display: flex;
      flex-direction: column;
      min-width: 0;
      width: 100%; /* å¡«æ»¡å‰©ä½™ç©ºé—´ */
      max-width: none; /* ç§»é™¤æœ€å¤§å®½åº¦é™åˆ¶ */
    }

    #chatbox {
      overflow-y: auto;
      padding: 20px; /* å‡å°‘å†…è¾¹è· */
      margin-bottom: 15px; /* å‡å°‘åº•éƒ¨è¾¹è· */
      background: rgba(255, 255, 255, 0.9);
      border-radius: 20px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
      backdrop-filter: blur(10px);
      height: calc(100vh - 280px); /* è°ƒæ•´é«˜åº¦ï¼Œä¸ºå›ºå®šè¾“å…¥æ¡†ç•™å‡ºç©ºé—´ */
      width: 100%; /* ç¡®ä¿å¡«æ»¡å®¹å™¨å®½åº¦ */
      min-height: 400px; /* è®¾ç½®æœ€å°é«˜åº¦ç¡®ä¿æœ‰æ»šåŠ¨å†…å®¹ */
    }

    .message {
      margin-bottom: 24px;
      display: flex;
      flex-direction: column;
      animation: fadeInUp 0.3s ease-out;
    }

    .message.user {
      align-items: flex-end;
    }

    .message.bot {
      align-items: flex-start;
    }

    @keyframes fadeInUp {
      from {
        opacity: 0;
        transform: translateY(20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .message-header {
      display: flex;
      align-items: center;
      margin-bottom: 8px;
    }

    .user .message-header {
      flex-direction: row-reverse;
    }

    .avatar {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      margin-right: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
      font-size: 14px;
      color: white;
    }

    .user .avatar {
      background: linear-gradient(135deg, #667eea, #764ba2);
      margin-right: 0;
      margin-left: 12px;
    }

    .bot .avatar {
      background: linear-gradient(135deg, #ffecd2, #fcb69f);
      color: #8b4513;
    }

    .sender-name {
      font-weight: 600;
      font-size: 14px;
      color: #2c3e50;
    }

    .message-content {
      background: #f8f9fa;
      padding: 16px 20px;
      border-radius: 16px;
      line-height: 1.6;
      color: #2c3e50;
      position: relative;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
      display: inline-block;
      max-width: 85%; /* å¢åŠ æœ€å¤§å®½åº¦ï¼Œè®©æ¶ˆæ¯å¯ä»¥æ›´å®½ */
      word-wrap: break-word;
    }

    .bot .message-content {
      margin-left: 44px;
    }

    .user .message-content {
      background: linear-gradient(135deg, #667eea, #764ba2);
      color: white;
      margin-right: 44px;
      text-align: left;
    }

    .message-content::before {
      content: '';
      position: absolute;
      top: 12px;
      left: -8px;
      width: 0;
      height: 0;
      border-style: solid;
      border-width: 8px 8px 8px 0;
      border-color: transparent #f8f9fa transparent transparent;
    }

    .user .message-content::before {
      left: auto;
      right: -8px;
      border-width: 8px 0 8px 8px;
      border-color: transparent transparent transparent #667eea;
    }

    .input-container {
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(10px);
      border-radius: 25px;
      padding: 16px 24px;
      display: flex;
      gap: 12px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
      border: 1px solid rgba(255, 255, 255, 0.2);
      position: fixed; /* å›ºå®šå®šä½ */
      bottom: 20px; /* è·ç¦»åº•éƒ¨20px */
      left: 340px; /* å·¦ä¾§ç•™å‡ºä¾§è¾¹æ ç©ºé—´ */
      right: 320px; /* å³ä¾§ç•™å‡ºåŠŸèƒ½æ ç©ºé—´ */
      z-index: 1000; /* ç¡®ä¿åœ¨å…¶ä»–å…ƒç´ ä¹‹ä¸Š */
      max-width: none; /* ç§»é™¤æœ€å¤§å®½åº¦é™åˆ¶ */
    }

    #input {
      flex: 1;
      border: none;
      outline: none;
      font-size: 16px;
      background: transparent;
      color: #2c3e50;
      padding: 8px 0;
    }

    #input::placeholder {
      color: #95a5a6;
    }

    #sendBtn {
      background: linear-gradient(135deg, #667eea, #764ba2);
      color: white;
      border: none;
      border-radius: 20px;
      padding: 12px 24px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
    }

    #stopBtn {
      background: linear-gradient(135deg, #e74c3c, #c0392b);
      color: white;
      border: none;
      border-radius: 20px;
      padding: 12px 20px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0 4px 15px rgba(231, 76, 60, 0.3);
      animation: pulse-red 1.5s infinite;
    }

    @keyframes pulse-red {
      0% { transform: scale(1); box-shadow: 0 4px 15px rgba(231, 76, 60, 0.3); }
      50% { transform: scale(1.05); box-shadow: 0 6px 20px rgba(231, 76, 60, 0.5); }
      100% { transform: scale(1); box-shadow: 0 4px 15px rgba(231, 76, 60, 0.3); }
    }

    #sendBtn:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
    }

    #stopBtn:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(231, 76, 60, 0.5);
      animation: none; /* æ‚¬åœæ—¶åœæ­¢è„‰å†²åŠ¨ç”» */
    }

    #sendBtn:active, #stopBtn:active {
      transform: translateY(0);
    }

    #sendBtn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      transform: none;
    }

    .typing-message {
      margin-bottom: 24px;
      display: flex;
      flex-direction: column;
      animation: fadeInUp 0.3s ease-out;
      align-items: flex-start;
    }

    .typing-content {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      padding: 12px 16px;
      border-radius: 18px 18px 18px 4px;
      color: white;
      position: relative;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      display: inline-block;
      max-width: fit-content;
      min-width: 60px;
    }

    .typing-content::before {
      content: '';
      position: absolute;
      top: 12px;
      left: -8px;
      width: 0;
      height: 0;
      border-style: solid;
      border-width: 8px 8px 8px 0;
      border-color: transparent #667eea transparent transparent;
    }

    .typing-dots {
      display: flex;
      gap: 4px;
      align-items: center;
      justify-content: center;
    }

    .typing-dot {
      width: 6px;
      height: 6px;
      background: rgba(255, 255, 255, 0.8);
      border-radius: 50%;
      animation: typing 1.4s infinite ease-in-out;
    }

    .typing-dot:nth-child(1) { animation-delay: -0.32s; }
    .typing-dot:nth-child(2) { animation-delay: -0.16s; }

    @keyframes typing {
      0%, 80%, 100% {
        transform: scale(0);
        opacity: 0.5;
      }
      40% {
        transform: scale(1);
        opacity: 1;
      }
    }

    .new-chat-btn {
      position: fixed;
      top: 25px;
      right: 25px;
      background: linear-gradient(135deg, #667eea, #764ba2);
      color: white;
      border: none;
      border-radius: 25px;
      padding: 12px 20px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      backdrop-filter: blur(10px);
      box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
      display: flex;
      align-items: center;
      gap: 8px;
      z-index: 1001; /* ç¡®ä¿åœ¨æœ€é¡¶å±‚ */
    }

    .new-chat-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
    }

    .new-chat-btn:active {
      transform: translateY(0);
    }

    .new-chat-icon {
      font-size: 16px;
      font-weight: bold;
    }

    /* æ»šåŠ¨æ¡æ ·å¼ */
    #chatbox::-webkit-scrollbar {
      width: 8px;
    }

    #chatbox::-webkit-scrollbar-track {
      background: rgba(0, 0, 0, 0.1);
      border-radius: 4px;
      margin: 10px 0;
    }

    #chatbox::-webkit-scrollbar-thumb {
      background: rgba(102, 126, 234, 0.5);
      border-radius: 4px;
      transition: background 0.3s ease;
    }

    #chatbox::-webkit-scrollbar-thumb:hover {
      background: rgba(102, 126, 234, 0.7);
    }

    #chatbox::-webkit-scrollbar-thumb:active {
      background: rgba(102, 126, 234, 0.9);
    }

    /* ä¾§è¾¹æ æ ·å¼ */
    .sidebar-header {
      padding: 20px;
      border-bottom: 1px solid rgba(0, 0, 0, 0.1);
      text-align: center;
    }

    .sidebar-title {
      font-weight: 600;
      font-size: 16px;
      color: #2c3e50;
      margin-bottom: 8px;
    }

    .sidebar-subtitle {
      font-size: 12px;
      color: #7f8c8d;
    }

    .history-list {
      flex: 1;
      overflow-y: auto;
      padding: 10px;
    }

    .history-item {
      background: rgba(102, 126, 234, 0.1);
      border-radius: 12px;
      padding: 12px 16px;
      margin-bottom: 8px;
      cursor: pointer;
      transition: all 0.3s ease;
      border-left: 3px solid transparent;
      position: relative;
    }

    .history-item:hover {
      background: rgba(102, 126, 234, 0.2);
      border-left-color: #667eea;
      transform: translateX(2px);
    }

    .history-item.active {
      background: linear-gradient(135deg, #667eea, #764ba2);
      color: white;
      border-left-color: #fff;
    }

    .history-question {
      font-size: 14px;
      font-weight: 500;
      margin-bottom: 4px;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    .history-time {
      font-size: 11px;
      opacity: 0.7;
    }

    .history-item.active .history-time {
      opacity: 0.9;
    }

    .sidebar-actions {
      padding: 15px 20px;
      border-top: 1px solid rgba(0, 0, 0, 0.1);
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .sidebar-btn {
      width: 100%;
      background: linear-gradient(135deg, #667eea, #764ba2);
      color: white;
      border: none;
      border-radius: 12px;
      padding: 10px 16px;
      font-size: 12px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .sidebar-btn:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
    }

    .sidebar-btn.secondary {
      background: rgba(102, 126, 234, 0.1);
      color: #667eea;
    }

    .sidebar-btn.secondary:hover {
      background: rgba(102, 126, 234, 0.2);
    }

    .toggle-sidebar {
      position: fixed;
      top: 50%;
      left: 340px; /* æ”¾åœ¨ä¾§è¾¹æ å³ä¾§ */
      transform: translateY(-50%);
      background: rgba(255, 255, 255, 0.9);
      border: none;
      border-radius: 50%;
      width: 48px;
      height: 48px;
      display: none;
      align-items: center;
      justify-content: center;
      font-size: 20px;
      cursor: pointer;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
      backdrop-filter: blur(10px);
      transition: all 0.3s ease;
      z-index: 1001;
    }

    .toggle-sidebar:hover {
      transform: translateY(-50%) scale(1.1);
    }

    .empty-history {
      text-align: center;
      padding: 40px 20px;
      color: #95a5a6;
      font-size: 14px;
    }

    .empty-history-icon {
      font-size: 48px;
      margin-bottom: 16px;
      opacity: 0.5;
    }

    /* æ»šåŠ¨æ¡æ ·å¼ - ä¾§è¾¹æ  */
    .history-list::-webkit-scrollbar {
      width: 4px;
    }

    .history-list::-webkit-scrollbar-track {
      background: rgba(0, 0, 0, 0.05);
      border-radius: 2px;
    }

    .history-list::-webkit-scrollbar-thumb {
      background: rgba(102, 126, 234, 0.3);
      border-radius: 2px;
    }

    .history-list::-webkit-scrollbar-thumb:hover {
      background: rgba(102, 126, 234, 0.5);
    }

    /* å¿«æ·æé—®åŒºåŸŸ */
    .quick-questions {
      padding: 20px; /* å‡å°‘å†…è¾¹è· */
      margin-bottom: 15px; /* å‡å°‘åº•éƒ¨è¾¹è· */
      background: rgba(255, 255, 255, 0.9);
      border-radius: 20px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
      backdrop-filter: blur(10px);
      width: 100%; /* ç¡®ä¿å¡«æ»¡å®¹å™¨å®½åº¦ */
    }

    .quick-questions-title {
      font-size: 16px;
      font-weight: 600;
      color: #2c3e50;
      margin-bottom: 15px;
      text-align: center;
    }

    .quick-questions-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); /* å¢åŠ æœ€å°å®½åº¦ */
      gap: 15px; /* å¢åŠ é—´è· */
    }

    .quick-question-btn {
      background: rgba(102, 126, 234, 0.1);
      border: 1px solid rgba(102, 126, 234, 0.2);
      border-radius: 12px;
      padding: 12px 16px;
      color: #667eea;
      font-size: 14px;
      cursor: pointer;
      transition: all 0.3s ease;
      text-align: left;
      font-weight: 500;
    }

    .quick-question-btn:hover {
      background: rgba(102, 126, 234, 0.2);
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(102, 126, 234, 0.2);
    }

    /* å³ä¾§åŠŸèƒ½æ  - å¯æ»šåŠ¨çš„å³ä¾§è¾¹æ  */
    .right-sidebar {
      width: 280px;
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(10px);
      border-radius: 20px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
      border: 1px solid rgba(255, 255, 255, 0.2);
      display: flex;
      flex-direction: column;
      position: fixed;
      top: 140px;
      right: 20px;
      bottom: 20px;
      max-height: calc(100vh - 160px);
      z-index: 100;
    }

    .control-section {
      padding: 20px;
      border-bottom: 1px solid rgba(0, 0, 0, 0.1);
    }

    .control-section-title {
      font-weight: 600;
      font-size: 14px;
      color: #2c3e50;
      margin-bottom: 15px;
      text-align: center;
    }

    .control-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 10px;
    }

    .control-btn {
      background: rgba(102, 126, 234, 0.1);
      border: 1px solid rgba(102, 126, 234, 0.2);
      border-radius: 12px;
      padding: 12px;
      color: #667eea;
      cursor: pointer;
      transition: all 0.3s ease;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 4px;
      font-size: 18px;
      min-height: 60px;
    }

    .control-btn-text {
      font-size: 10px;
      font-weight: 500;
      text-align: center;
      line-height: 1.2;
    }

    .control-btn:hover {
      background: rgba(102, 126, 234, 0.2);
      color: #667eea;
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(102, 126, 234, 0.2);
    }

    .control-btn.active {
      background: linear-gradient(135deg, #667eea, #764ba2);
      color: white;
      border-color: transparent;
    }

    /* å³ä¾§å·¥å…·æ åŒºåŸŸ */
    .tools-section {
      padding: 20px;
      border-bottom: 1px solid rgba(0, 0, 0, 0.1);
    }

    .tool-grid {
      display: grid;
      grid-template-columns: 1fr;
      gap: 8px;
    }

    .tool-btn {
      background: rgba(102, 126, 234, 0.1);
      border: 1px solid rgba(102, 126, 234, 0.2);
      border-radius: 10px;
      padding: 10px 12px;
      color: #667eea;
      cursor: pointer;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 12px;
      font-weight: 500;
    }

    .tool-btn:hover {
      background: rgba(102, 126, 234, 0.2);
      transform: translateY(-1px);
      box-shadow: 0 2px 8px rgba(102, 126, 234, 0.2);
    }

    /* æœç´¢æ¡† */
    .search-container {
      padding: 10px 20px;
      border-bottom: 1px solid rgba(0, 0, 0, 0.1);
    }

    .search-input {
      width: 100%;
      padding: 8px 12px;
      border: 1px solid rgba(102, 126, 234, 0.3);
      border-radius: 8px;
      font-size: 12px;
      background: rgba(102, 126, 234, 0.05);
      color: #2c3e50;
    }

    .search-input:focus {
      outline: none;
      border-color: #667eea;
      background: white;
    }

    /* ç»Ÿè®¡ä¿¡æ¯ */
    .stats-info {
      padding: 15px 20px;
      border-bottom: 1px solid rgba(0, 0, 0, 0.1);
      font-size: 11px;
      color: #7f8c8d;
      text-align: center;
    }

    .stats-item {
      display: inline-block;
      margin: 0 8px;
    }

    /* è¯­éŸ³è¾“å…¥æŒ‰é’® */
    .voice-btn {
      background: transparent;
      border: none;
      color: #667eea;
      font-size: 18px;
      cursor: pointer;
      transition: all 0.3s ease;
      padding: 8px;
      border-radius: 50%;
    }

    .voice-btn:hover {
      background: rgba(102, 126, 234, 0.1);
      transform: scale(1.1);
    }

    .voice-btn.recording {
      color: #e74c3c;
      animation: pulse 1s infinite;
    }

    @keyframes pulse {
      0% { transform: scale(1); }
      50% { transform: scale(1.1); }
      100% { transform: scale(1); }
    }

    /* å¤œé—´æ¨¡å¼ */
    body.dark-theme {
      background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
    }

    body.dark-theme .header {
      background: rgba(52, 73, 94, 0.95);
    }

    body.dark-theme .header h1 {
      color: #ecf0f1;
    }

    body.dark-theme .header p {
      color: #bdc3c7;
    }

    body.dark-theme .sidebar {
      background: rgba(52, 73, 94, 0.95);
    }

    body.dark-theme .sidebar-title {
      color: #ecf0f1;
    }

    body.dark-theme .sidebar-subtitle {
      color: #bdc3c7;
    }

    body.dark-theme #chatbox {
      background: rgba(52, 73, 94, 0.9);
    }

    body.dark-theme .message-content {
      background: #34495e;
      color: #ecf0f1;
    }

    body.dark-theme .message-content::before {
      border-color: transparent #34495e transparent transparent;
    }

    body.dark-theme .input-container {
      background: rgba(52, 73, 94, 0.95);
    }

    body.dark-theme #input {
      color: #ecf0f1;
    }

    body.dark-theme #input::placeholder {
      color: #95a5a6;
    }

    body.dark-theme #stopBtn {
      background: linear-gradient(135deg, #e74c3c, #c0392b);
      box-shadow: 0 4px 15px rgba(231, 76, 60, 0.4);
    }

    body.dark-theme .right-sidebar {
      background: rgba(52, 73, 94, 0.95);
    }

    body.dark-theme .control-section-title {
      color: #ecf0f1;
    }

    body.dark-theme .control-btn {
      background: rgba(102, 126, 234, 0.2);
      color: #3498db;
      border-color: rgba(102, 126, 234, 0.3);
    }

    body.dark-theme .tool-btn {
      background: rgba(102, 126, 234, 0.2);
      color: #3498db;
      border-color: rgba(102, 126, 234, 0.3);
    }

    body.dark-theme .quick-questions {
      background: rgba(52, 73, 94, 0.9);
    }

    body.dark-theme .quick-questions-title {
      color: #ecf0f1;
    }

    body.dark-theme .quick-question-btn {
      background: rgba(102, 126, 234, 0.2);
      color: #3498db;
      border-color: rgba(102, 126, 234, 0.3);
    }

    /* å“åº”å¼è®¾è®¡ */
    @media (max-width: 768px) {
      .right-sidebar {
        position: relative;
        top: auto;
        right: auto;
        bottom: auto;
        width: 100%;
        border-radius: 0;
        max-height: 250px;
        box-shadow: none;
        border: none;
        margin-bottom: 20px;
        order: -1; /* åœ¨ç§»åŠ¨ç«¯æ˜¾ç¤ºåœ¨é¡¶éƒ¨ */
      }

      .control-grid {
        grid-template-columns: repeat(4, 1fr);
        gap: 8px;
      }

      .control-btn {
        min-height: 50px;
        font-size: 16px;
        padding: 8px;
      }

      .control-btn-text {
        font-size: 9px;
      }

      .tool-grid {
        grid-template-columns: repeat(2, 1fr);
        gap: 6px;
      }

      .tool-btn {
        font-size: 11px;
        padding: 8px 10px;
      }

      .new-chat-btn {
        top: 15px;
        right: 15px;
        padding: 8px 14px;
        font-size: 12px;
      }

      .quick-questions {
        padding: 15px;
        margin-bottom: 15px;
      }

      .quick-questions-grid {
        grid-template-columns: 1fr;
        gap: 8px;
      }

      .quick-question-btn {
        padding: 10px 12px;
        font-size: 13px;
      }

      .main-content {
        padding: 10px;
        padding-left: 10px; /* ç§»åŠ¨ç«¯æ¢å¤æ­£å¸¸padding */
        padding-right: 10px;
        padding-top: 80px; /* ä¸ºé¡¶éƒ¨æŒ‰é’®ç•™å‡ºç©ºé—´ */
        gap: 10px; /* ç§»åŠ¨ç«¯æ·»åŠ å°é—´è· */
      }

      #chatbox {
        padding: 20px; /* ç§»åŠ¨ç«¯å‡å°‘å†…è¾¹è· */
        height: calc(100vh - 200px); /* ç§»åŠ¨ç«¯è°ƒæ•´é«˜åº¦ï¼Œä¸ºå›ºå®šè¾“å…¥æ¡†ç•™å‡ºç©ºé—´ */
        margin-bottom: 80px; /* ä¸ºåº•éƒ¨å›ºå®šè¾“å…¥æ¡†ç•™å‡ºç©ºé—´ */
      }

      .quick-questions {
        padding: 15px; /* ç§»åŠ¨ç«¯å‡å°‘å†…è¾¹è· */
      }

      .sidebar {
        position: relative;
        top: auto;
        left: auto;
        bottom: auto;
        width: 100%;
        border-radius: 0;
        max-height: 200px;
        box-shadow: none;
        border: none;
        margin-bottom: 20px;
      }
      
      .header h1 {
        font-size: 24px;
      }
      
      .input-container {
        padding: 12px 16px;
        left: 10px; /* ç§»åŠ¨ç«¯å·¦è¾¹è· */
        right: 10px; /* ç§»åŠ¨ç«¯å³è¾¹è· */
        bottom: 10px; /* ç§»åŠ¨ç«¯åº•éƒ¨è¾¹è· */
      }
      
      .send-btn {
        padding: 10px 20px;
      }

      .message-content {
        max-width: 85%;
        margin-left: 36px !important;
        margin-right: 36px !important;
      }

      .bot .message-content {
        margin-left: 36px;
      }

      .user .message-content {
        margin-right: 36px;
      }

      .avatar {
        width: 28px;
        height: 28px;
        font-size: 12px;
        margin-right: 8px;
      }

      .user .avatar {
        margin-right: 0;
        margin-left: 8px;
      }

      .sidebar-header {
        display: none;
      }

      .history-list {
        padding: 0;
      }

      .history-item {
        padding: 10px 14px;
      }

      .sidebar-actions {
        flex-direction: column;
        padding: 10px;
        gap: 8px;
      }

      .sidebar-btn {
        width: 100%;
        margin-bottom: 0;
      }

      .toggle-sidebar {
        display: flex;
        left: 20px;
      }
    }

    @media (max-width: 1024px) and (min-width: 769px) {
      .sidebar {
        width: 250px;
        left: 15px;
        top: 80px;
      }

      .right-sidebar {
        width: 240px;
        right: 15px;
        top: 80px;
      }

      .main-content {
        padding: 15px;
        padding-left: 285px; /* è°ƒæ•´ä¸­ç­‰å±å¹•çš„ç•™ç™½ */
        padding-right: 270px; /* ä¸ºå³ä¾§è¾¹æ ç•™å‡ºç©ºé—´ */
      }

      .input-container {
        left: 285px; /* è°ƒæ•´ä¸­ç­‰å±å¹•çš„è¾“å…¥æ¡†ä½ç½® */
        right: 270px;
      }
    }

    /* ä¸­ç­‰å±å¹•è°ƒæ•´å¸ƒå±€ */
    @media (max-width: 768px) {
      .bottom-toolbar {
        bottom: 20px;
        left: 20px;
        right: 20px;
        transform: none;
        width: auto;
        flex-wrap: wrap;
        justify-content: center;
      }
      
      .bottom-tool-btn {
        font-size: 11px;
        padding: 6px 10px;
      }
    }
  </style>
</head>
<body>
  <div class="header">
    <h1>ğŸª æ™ºèƒ½åº—é“ºåŠ©æ‰‹</h1>
    <p>åŸºäºRAGæŠ€æœ¯çš„å•†æˆ·æ¨èä¸åˆ†æä¸“å®¶</p>
  </div>
  
  <button class="new-chat-btn" onclick="startNewChat()">
    <span class="new-chat-icon">+</span>
    å¼€å¯æ–°å¯¹è¯
  </button>
  <button class="toggle-sidebar" onclick="toggleSidebar()">ğŸ“</button>
  




ï¿½</button>
  </div>
  
  <div class="main-content">
    <div class="sidebar" id="sidebar">
      <div class="sidebar-header">
        <div class="sidebar-title">ğŸ“ å†å²è®°å½•</div>
        <div class="sidebar-subtitle">æŸ¥çœ‹è¿‡å¾€å¯¹è¯</div>
      </div>
      
      <!-- æœç´¢æ¡† -->
      <div class="search-container" id="searchContainer" style="display: none;">
        <input type="text" class="search-input" id="searchInput" placeholder="æœç´¢å†å²è®°å½•..." onkeyup="searchHistory()">
      </div>
      
      <!-- ç»Ÿè®¡ä¿¡æ¯ -->
      <div class="stats-info" id="statsInfo">
        <span class="stats-item">æ€»å¯¹è¯: <span id="totalChats">0</span></span>
        <span class="stats-item">ä»Šæ—¥: <span id="todayChats">0</span></span>
        <span class="stats-item">æ¶ˆæ¯: <span id="totalMessages">0</span></span>
      </div>
      
      <div class="history-list" id="historyList">
        <div class="empty-history">
          <div class="empty-history-icon">ğŸ’­</div>
          <div>æš‚æ— å†å²è®°å½•</div>
        </div>
      </div>
      <div class="sidebar-actions">
        <button class="sidebar-btn secondary" onclick="clearHistory()">æ¸…ç©ºå†å²</button>
        <button class="sidebar-btn secondary" onclick="clearChat()">æ¸…ç©ºå¯¹è¯</button>
      </div>
    </div>
    
    <div class="chat-container">
      <!-- å¿«æ·æé—®åŒºåŸŸ -->
      <div class="quick-questions" id="quickQuestions">
        <div class="quick-questions-title">ğŸ’¡ å¸¸è§é—®é¢˜</div>
        <div class="quick-questions-grid">
          <button class="quick-question-btn" onclick="askQuestion('æ¨èé™„è¿‘çš„é¤å…')">ğŸ½ï¸ æ¨èé™„è¿‘çš„é¤å…</button>
          <button class="quick-question-btn" onclick="askQuestion('æŸ¥æ‰¾è¯„åˆ†æœ€é«˜çš„å’–å•¡åº—')">â˜• æŸ¥æ‰¾è¯„åˆ†æœ€é«˜çš„å’–å•¡åº—</button>
          <button class="quick-question-btn" onclick="askQuestion('åˆ†æç”¨æˆ·è¯„ä»·è¶‹åŠ¿')">ğŸ“ˆ åˆ†æç”¨æˆ·è¯„ä»·è¶‹åŠ¿</button>
          <button class="quick-question-btn" onclick="askQuestion('æ¯”è¾ƒä¸åŒå•†å®¶çš„æœåŠ¡è´¨é‡')">âš–ï¸ æ¯”è¾ƒå•†å®¶æœåŠ¡è´¨é‡</button>
        </div>
      </div>
      
      <div id="chatbox">
        <div class="message bot">
          <div class="message-header">
            <div class="avatar">ğŸ¤–</div>
            <span class="sender-name">æ™ºèƒ½åŠ©æ‰‹</span>
          </div>
          <div class="message-content">
            æ‚¨å¥½ï¼æˆ‘æ˜¯æ‚¨çš„æ™ºèƒ½åº—é“ºåŠ©æ‰‹ï¼Œå¯ä»¥ä¸ºæ‚¨æä¾›ï¼š<br>
            ğŸ“ åº—é“ºæ¨èä¸æœç´¢<br>
            ğŸ“Š å•†ä¸šæ•°æ®åˆ†æ<br>
            â­ ç”¨æˆ·è¯„ä»·è§£è¯»<br>
            ğŸ¯ ä¸ªæ€§åŒ–å»ºè®®<br><br>
            è¯·å‘Šè¯‰æˆ‘æ‚¨æƒ³äº†è§£ä»€ä¹ˆï¼Ÿ
          </div>
        </div>
        
        <!-- æµ‹è¯•æ¶ˆæ¯ï¼Œç”¨äºå±•ç¤ºæ»šåŠ¨æ•ˆæœ -->
        <div class="message user">
          <div class="message-header">
            <div class="avatar">ğŸ‘¤</div>
            <span class="sender-name">æ‚¨</span>
          </div>
          <div class="message-content">
            æµ‹è¯•æ¶ˆæ¯ï¼šæ¨èä¸€äº›é™„è¿‘çš„é¤å…
          </div>
        </div>
        
        <div class="message bot">
          <div class="message-header">
            <div class="avatar">ğŸ¤–</div>
            <span class="sender-name">æ™ºèƒ½åŠ©æ‰‹</span>
          </div>
          <div class="message-content">
            æ ¹æ®æ‚¨çš„ä½ç½®ï¼Œæˆ‘ä¸ºæ‚¨æ¨èä»¥ä¸‹å‡ å®¶ä¼˜è´¨é¤å…ï¼š<br><br>
            ğŸ½ï¸ <strong>é‡‘é™µå¤§é…’åº—</strong><br>
            ğŸ“ åœ°å€ï¼šå¸‚ä¸­å¿ƒå•†ä¸šåŒº<br>
            â­ è¯„åˆ†ï¼š4.8/5.0<br>
            ğŸ’° äººå‡ï¼š120-200å…ƒ<br>
            ğŸ·ï¸ ç‰¹è‰²ï¼šæ­£å®—æ·®æ‰¬èœï¼Œç¯å¢ƒä¼˜é›…<br><br>
            
            ğŸœ <strong>è€å‹è®°é¢é¦†</strong><br>
            ğŸ“ åœ°å€ï¼šæ–‡åŒ–è¡—å°å··<br>
            â­ è¯„åˆ†ï¼š4.6/5.0<br>
            ğŸ’° äººå‡ï¼š25-45å…ƒ<br>
            ğŸ·ï¸ ç‰¹è‰²ï¼šæ‰‹å·¥æ‹‰é¢ï¼Œæ±¤åº•æµ“éƒ<br><br>
            
            ğŸ¥˜ <strong>å·é¦™æ»¡å›­</strong><br>
            ğŸ“ åœ°å€ï¼šç¾é£Ÿå¹¿åœº3æ¥¼<br>
            â­ è¯„åˆ†ï¼š4.7/5.0<br>
            ğŸ’° äººå‡ï¼š80-120å…ƒ<br>
            ğŸ·ï¸ ç‰¹è‰²ï¼šæ­£å®—å·èœï¼Œè¾£å‘³åè¶³
          </div>
        </div>
        
        <div class="message user">
          <div class="message-header">
            <div class="avatar">ğŸ‘¤</div>
            <span class="sender-name">æ‚¨</span>
          </div>
          <div class="message-content">
            èƒ½åˆ†æä¸€ä¸‹è¿™äº›é¤å…çš„ç”¨æˆ·è¯„ä»·å—ï¼Ÿ
          </div>
        </div>
        
        <div class="message bot">
          <div class="message-header">
            <div class="avatar">ğŸ¤–</div>
            <span class="sender-name">æ™ºèƒ½åŠ©æ‰‹</span>
          </div>
          <div class="message-content">
            ğŸ“Š <strong>ç”¨æˆ·è¯„ä»·åˆ†ææŠ¥å‘Š</strong><br><br>
            
            <strong>é‡‘é™µå¤§é…’åº—</strong><br>
            ğŸ‘ æ­£é¢è¯„ä»· (85%)ï¼š<br>
            â€¢ èœå“ç²¾è‡´ï¼Œå£å‘³æ­£å®—<br>
            â€¢ æœåŠ¡æ€åº¦ä¼˜ç§€<br>
            â€¢ ç¯å¢ƒé«˜é›…ï¼Œé€‚åˆå•†åŠ¡å®´è¯·<br>
            ğŸ‘ è´Ÿé¢è¯„ä»· (15%)ï¼š<br>
            â€¢ ä»·æ ¼åé«˜<br>
            â€¢ åœè½¦ä½è¾ƒå°‘<br><br>
            
            <strong>è€å‹è®°é¢é¦†</strong><br>
            ğŸ‘ æ­£é¢è¯„ä»· (92%)ï¼š<br>
            â€¢ æ€§ä»·æ¯”æé«˜<br>
            â€¢ é¢æ¡åŠ²é“ï¼Œæ±¤å¤´é²œç¾<br>
            â€¢ åˆ†é‡è¶³ï¼Œè€æ¿äººå¾ˆå¥½<br>
            ğŸ‘ è´Ÿé¢è¯„ä»· (8%)ï¼š<br>
            â€¢ åº—é¢è¾ƒå°ï¼Œæ’é˜Ÿæ—¶é—´é•¿<br>
            â€¢ è£…ä¿®ç®€å•<br><br>
            
            <strong>å·é¦™æ»¡å›­</strong><br>
            ğŸ‘ æ­£é¢è¯„ä»· (88%)ï¼š<br>
            â€¢ å·èœæ­£å®—ï¼Œè¾£åº¦é€‚ä¸­<br>
            â€¢ èœå“ä¸°å¯Œï¼Œé€‰æ‹©å¤šæ ·<br>
            â€¢ ä½ç½®ä¾¿åˆ©ï¼Œå¥½æ‰¾<br>
            ğŸ‘ è´Ÿé¢è¯„ä»· (12%)ï¼š<br>
            â€¢ é«˜å³°æœŸä¸Šèœè¾ƒæ…¢<br>
            â€¢ éƒ¨åˆ†èœå“åå’¸
          </div>
        </div>
        
        <div class="message user">
          <div class="message-header">
            <div class="avatar">ğŸ‘¤</div>
            <span class="sender-name">æ‚¨</span>
          </div>
          <div class="message-content">
            è¿™äº›ä¿¡æ¯å¾ˆæœ‰ç”¨ï¼Œè°¢è°¢ï¼è¿˜æœ‰å…¶ä»–æ¨èå—ï¼Ÿ
          </div>
        </div>
        
        <div class="message bot">
          <div class="message-header">
            <div class="avatar">ğŸ¤–</div>
            <span class="sender-name">æ™ºèƒ½åŠ©æ‰‹</span>
          </div>
          <div class="message-content">
            å¾ˆé«˜å…´èƒ½å¸®åŠ©æ‚¨ï¼ğŸ‰ æ ¹æ®æ‚¨çš„å–œå¥½ï¼Œæˆ‘è¿˜å¯ä»¥ä¸ºæ‚¨æ¨èï¼š<br><br>
            
            ğŸ£ <strong>æ—¥å¼æ–™ç†</strong>ï¼šæ¨±èŠ±å¯¿å¸åº— (4.5æ˜Ÿ)<br>
            ğŸ• <strong>è¥¿å¼é¤å…</strong>ï¼šæ„å¤§åˆ©é¢å±‹ (4.6æ˜Ÿ)<br>
            ğŸ¥— <strong>å¥åº·è½»é£Ÿ</strong>ï¼šç»¿è‰²æ²™æ‹‰å§ (4.4æ˜Ÿ)<br>
            ğŸ° <strong>ç”œå“å’–å•¡</strong>ï¼šæ˜Ÿå·´å…‹&å“ˆæ ¹è¾¾æ–¯ (4.7æ˜Ÿ)<br><br>
            
            å¦‚æœæ‚¨éœ€è¦äº†è§£å…·ä½“æŸå®¶åº—çš„è¯¦ç»†ä¿¡æ¯ã€é¢„è®¢æƒ…å†µæˆ–è€…è·¯çº¿æŒ‡å¼•ï¼Œè¯·éšæ—¶å‘Šè¯‰æˆ‘ï¼æˆ‘è¿˜å¯ä»¥æ ¹æ®æ‚¨çš„å…·ä½“éœ€æ±‚ï¼ˆå¦‚é¢„ç®—ã€ç”¨é¤äººæ•°ã€ç‰¹æ®Šé¥®é£Ÿè¦æ±‚ç­‰ï¼‰æä¾›æ›´ç²¾å‡†çš„æ¨èã€‚ğŸ˜Š
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- å›ºå®šåœ¨åº•éƒ¨çš„è¾“å…¥æ¡† -->
  <div class="input-container">
    <input type="text" id="input" placeholder="è¾“å…¥æ‚¨çš„é—®é¢˜..." maxlength="500">
    <button class="voice-btn" onclick="toggleVoiceInput()" title="è¯­éŸ³è¾“å…¥">ğŸ¤</button>
    <button class="stop-btn" id="stopBtn" onclick="stopGeneration()" title="åœæ­¢ç”Ÿæˆ" style="display: none;">â¹ï¸</button>
    <button class="send-btn" id="sendBtn" onclick="send()">å‘é€</button>
  </div>

  <!-- å³ä¾§åŠŸèƒ½æ  - å¯æ»šåŠ¨ -->
  <div class="right-sidebar">
    <!-- åŠŸèƒ½æ§åˆ¶åŒºåŸŸ -->
    <div class="control-section">
      <div class="control-section-title">ğŸ›ï¸ åŠŸèƒ½æ§åˆ¶</div>
      <div class="control-grid">
        <button class="control-btn" onclick="toggleTheme()" title="åˆ‡æ¢ä¸»é¢˜">
          <span>ğŸŒ“</span>
          <span class="control-btn-text">ä¸»é¢˜</span>
        </button>
        <button class="control-btn" onclick="adjustFontSize('increase')" title="å¢å¤§å­—ä½“">
          <span>ğŸ”</span>
          <span class="control-btn-text">æ”¾å¤§</span>
        </button>
        <button class="control-btn" onclick="adjustFontSize('decrease')" title="å‡å°å­—ä½“">
          <span>ğŸ”</span>
          <span class="control-btn-text">ç¼©å°</span>
        </button>
        <button class="control-btn" onclick="toggleSearch()" title="æœç´¢å†å²">
          <span>ğŸ”</span>
          <span class="control-btn-text">æœç´¢</span>
        </button>
        <button class="control-btn" onclick="showStats()" title="ä½¿ç”¨ç»Ÿè®¡">
          <span>ğŸ“Š</span>
          <span class="control-btn-text">ç»Ÿè®¡</span>
        </button>
        <button class="control-btn" onclick="toggleFullscreen()" title="å…¨å±æ¨¡å¼">
          <span>ğŸ”²</span>
          <span class="control-btn-text">å…¨å±</span>
        </button>
      </div>
    </div>

    <!-- å·¥å…·åŒºåŸŸ -->
    <div class="tools-section">
      <div class="control-section-title">ğŸ› ï¸ å®ç”¨å·¥å…·</div>
      <div class="tool-grid">
        <button class="tool-btn" onclick="exportText()" title="å¯¼å‡ºå¯¹è¯è®°å½•ä¸ºæ–‡æœ¬">
          ğŸ“„ å¯¼å‡ºæ–‡æœ¬
        </button>
        <button class="tool-btn" onclick="exportHistory()" title="å¯¼å‡ºå¯¹è¯è®°å½•ä¸ºJSON">
          ğŸ’¾ å¯¼å‡ºJSON
        </button>
        <button class="tool-btn" onclick="scrollToTop()" title="å›åˆ°é¡¶éƒ¨">
          â¬†ï¸ å›åˆ°é¡¶éƒ¨
        </button>
        <button class="tool-btn" onclick="scrollToBottomSmooth()" title="æ»šåŠ¨åˆ°åº•éƒ¨">
          â¬‡ï¸ æ»šåŠ¨åº•éƒ¨
        </button>
        <button class="tool-btn" onclick="showHelp()" title="ä½¿ç”¨å¸®åŠ©">
          â“ ä½¿ç”¨å¸®åŠ©
        </button>
        <button class="tool-btn" onclick="showAbout()" title="å…³äºæˆ‘ä»¬">
          â„¹ï¸ å…³äºæˆ‘ä»¬
        </button>
      </div>
    </div>

    <!-- å¿«æ·æ“ä½œåŒºåŸŸ -->
    <div class="tools-section">
      <div class="control-section-title">âš¡ å¿«æ·æ“ä½œ</div>
      <div class="tool-grid">
        <button class="tool-btn" onclick="startNewChat()" title="å¼€å¯æ–°çš„å¯¹è¯">
          â• æ–°å»ºå¯¹è¯
        </button>
        <button class="tool-btn" onclick="clearChat()" title="æ¸…ç©ºå½“å‰å¯¹è¯å†…å®¹">
          ğŸ—‘ï¸ æ¸…ç©ºå¯¹è¯
        </button>
        <button class="tool-btn" onclick="toggleSidebar()" title="æ˜¾ç¤º/éšè—å†å²è®°å½•">
          ğŸ“ åˆ‡æ¢å†å²
        </button>
      </div>
    </div>
  </div>

  <script>
    let messageCount = 0;
    let chatHistory = JSON.parse(localStorage.getItem('chatHistory') || '[]');
    let currentSession = null;
    let currentTheme = localStorage.getItem('theme') || 'light';
    let currentFontSize = parseInt(localStorage.getItem('fontSize')) || 16;
    let isSearchVisible = false;
    let isVoiceRecording = false;
    let filteredHistory = [];
    let isGenerating = false; // è·Ÿè¸ªAIæ˜¯å¦æ­£åœ¨ç”Ÿæˆ
    let currentAbortController = null; // ç”¨äºå–æ¶ˆè¯·æ±‚
    let currentTypewriterTimeout = null; // è·Ÿè¸ªå½“å‰çš„æ‰“å­—è¶…æ—¶

    // æ˜¾ç¤ºåœæ­¢æŒ‰é’®
    function showStopButton() {
      const stopBtn = document.getElementById('stopBtn');
      const sendBtn = document.getElementById('sendBtn');
      stopBtn.style.display = 'block';
      sendBtn.style.display = 'none';
      isGenerating = true;
    }

    // éšè—åœæ­¢æŒ‰é’®
    function hideStopButton() {
      const stopBtn = document.getElementById('stopBtn');
      const sendBtn = document.getElementById('sendBtn');
      stopBtn.style.display = 'none';
      sendBtn.style.display = 'block';
      isGenerating = false;
    }

    // åœæ­¢ç”Ÿæˆ
    function stopGeneration() {
      // ç«‹å³è®¾ç½®çŠ¶æ€ä¸ºéç”ŸæˆçŠ¶æ€
      isGenerating = false;
      
      // ä¸­æ–­ç½‘ç»œè¯·æ±‚
      if (currentAbortController) {
        currentAbortController.abort();
        currentAbortController = null;
      }
      
      // æ¸…é™¤æ‰“å­—æ•ˆæœè¶…æ—¶
      if (currentTypewriterTimeout) {
        clearTimeout(currentTypewriterTimeout);
        currentTypewriterTimeout = null;
      }
      
      // éšè—æ‰“å­—æŒ‡ç¤ºå™¨
      hideTypingIndicator();
      
      // æ·»åŠ ä¸­æ–­æ¶ˆæ¯
      appendMessage("ç³»ç»Ÿ", "âŒ ç”Ÿæˆå·²è¢«ç”¨æˆ·ä¸­æ–­", "bot");
      
      // æ¢å¤ç•Œé¢çŠ¶æ€
      hideStopButton();
      const input = document.getElementById("input");
      input.disabled = false;
      input.focus();
    }

    // åˆå§‹åŒ–é¡µé¢
    function initializePage() {
      applyTheme();
      applyFontSize();
      updateStats();
      initHistory();
      hideQuickQuestions();
    }

    // ä¸»é¢˜åˆ‡æ¢
    function toggleTheme() {
      currentTheme = currentTheme === 'light' ? 'dark' : 'light';
      localStorage.setItem('theme', currentTheme);
      applyTheme();
    }

    function applyTheme() {
      if (currentTheme === 'dark') {
        document.body.classList.add('dark-theme');
      } else {
        document.body.classList.remove('dark-theme');
      }
    }

    // å­—ä½“å¤§å°è°ƒèŠ‚
    function adjustFontSize(action) {
      if (action === 'increase' && currentFontSize < 24) {
        currentFontSize += 2;
      } else if (action === 'decrease' && currentFontSize > 12) {
        currentFontSize -= 2;
      }
      localStorage.setItem('fontSize', currentFontSize);
      applyFontSize();
    }

    function applyFontSize() {
      document.body.style.fontSize = currentFontSize + 'px';
    }

    // æœç´¢åŠŸèƒ½
    function toggleSearch() {
      const searchContainer = document.getElementById('searchContainer');
      const searchInput = document.getElementById('searchInput');
      
      isSearchVisible = !isSearchVisible;
      searchContainer.style.display = isSearchVisible ? 'block' : 'none';
      
      if (isSearchVisible) {
        searchInput.focus();
      } else {
        searchInput.value = '';
        displayHistory(); // é‡ç½®æ˜¾ç¤º
      }
    }

    function searchHistory() {
      const query = document.getElementById('searchInput').value.toLowerCase();
      if (!query) {
        displayHistory();
        return;
      }

      filteredHistory = chatHistory.filter(session => 
        session.firstQuestion.toLowerCase().includes(query) ||
        session.messages.some(msg => msg.content.toLowerCase().includes(query))
      );

      displayFilteredHistory();
    }

    function displayFilteredHistory() {
      const historyList = document.getElementById('historyList');
      
      if (filteredHistory.length === 0) {
        historyList.innerHTML = `
          <div class="empty-history">
            <div class="empty-history-icon">ğŸ”</div>
            <div>æœªæ‰¾åˆ°åŒ¹é…çš„è®°å½•</div>
          </div>
        `;
        return;
      }

      historyList.innerHTML = filteredHistory.map((session, index) => {
        const originalIndex = chatHistory.indexOf(session);
        return `
          <div class="history-item ${currentSession === originalIndex ? 'active' : ''}" 
               onclick="loadSession(${originalIndex})">
            <div class="history-question">${session.firstQuestion}</div>
            <div class="history-time">${formatTime(session.timestamp)}</div>
          </div>
        `;
      }).join('');
    }

    // ç»Ÿè®¡åŠŸèƒ½
    function updateStats() {
      const totalChats = chatHistory.length;
      const today = new Date().toDateString();
      const todayChats = chatHistory.filter(session => 
        new Date(session.timestamp).toDateString() === today
      ).length;
      const totalMessages = chatHistory.reduce((sum, session) => sum + session.messages.length, 0);

      document.getElementById('totalChats').textContent = totalChats;
      document.getElementById('todayChats').textContent = todayChats;
      document.getElementById('totalMessages').textContent = totalMessages;
    }

    function showStats() {
      const stats = calculateDetailedStats();
      alert(`ğŸ“Š ä½¿ç”¨ç»Ÿè®¡\n\n` +
        `æ€»å¯¹è¯æ•°: ${stats.totalChats}\n` +
        `ä»Šæ—¥å¯¹è¯: ${stats.todayChats}\n` +
        `æ€»æ¶ˆæ¯æ•°: ${stats.totalMessages}\n` +
        `å¹³å‡æ¯è¯æ¶ˆæ¯: ${stats.avgMessages}\n` +
        `æœ€æ´»è·ƒæ—¥æœŸ: ${stats.mostActiveDate}\n` +
        `ä½¿ç”¨å¤©æ•°: ${stats.usageDays}`);
    }

    function calculateDetailedStats() {
      const totalChats = chatHistory.length;
      const today = new Date().toDateString();
      const todayChats = chatHistory.filter(session => 
        new Date(session.timestamp).toDateString() === today
      ).length;
      const totalMessages = chatHistory.reduce((sum, session) => sum + session.messages.length, 0);
      const avgMessages = totalChats > 0 ? Math.round(totalMessages / totalChats) : 0;
      
      // è®¡ç®—æœ€æ´»è·ƒæ—¥æœŸ
      const dateCounts = {};
      chatHistory.forEach(session => {
        const date = new Date(session.timestamp).toDateString();
        dateCounts[date] = (dateCounts[date] || 0) + 1;
      });
      
      const mostActiveDate = Object.keys(dateCounts).reduce((a, b) => 
        dateCounts[a] > dateCounts[b] ? a : b, 'æ— æ•°æ®'
      );
      
      const usageDays = Object.keys(dateCounts).length;

      return {
        totalChats,
        todayChats,
        totalMessages,
        avgMessages,
        mostActiveDate,
        usageDays
      };
    }

    // è¯­éŸ³è¾“å…¥åŠŸèƒ½
    function toggleVoiceInput() {
      if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
        alert('æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒè¯­éŸ³è¯†åˆ«åŠŸèƒ½');
        return;
      }

      const voiceBtn = document.querySelector('.voice-btn');
      
      if (isVoiceRecording) {
        stopVoiceRecording();
        return;
      }

      const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
      const recognition = new SpeechRecognition();
      
      recognition.lang = 'zh-CN';
      recognition.continuous = false;
      recognition.interimResults = false;

      recognition.onstart = function() {
        isVoiceRecording = true;
        voiceBtn.classList.add('recording');
        voiceBtn.title = 'ç‚¹å‡»åœæ­¢å½•éŸ³';
      };

      recognition.onresult = function(event) {
        const transcript = event.results[0][0].transcript;
        document.getElementById('input').value = transcript;
      };

      recognition.onerror = function(event) {
        console.error('è¯­éŸ³è¯†åˆ«é”™è¯¯:', event.error);
        alert('è¯­éŸ³è¯†åˆ«å¤±è´¥ï¼Œè¯·é‡è¯•');
      };

      recognition.onend = function() {
        stopVoiceRecording();
      };

      recognition.start();
      window.currentRecognition = recognition;
    }

    function stopVoiceRecording() {
      isVoiceRecording = false;
      const voiceBtn = document.querySelector('.voice-btn');
      voiceBtn.classList.remove('recording');
      voiceBtn.title = 'è¯­éŸ³è¾“å…¥';
      
      if (window.currentRecognition) {
        window.currentRecognition.stop();
      }
    }

    // å¿«æ·æé—®åŠŸèƒ½
    function askQuestion(question) {
      document.getElementById('input').value = question;
      send();
    }

    function hideQuickQuestions() {
      // å¦‚æœæœ‰å†å²è®°å½•æˆ–å½“å‰æœ‰å¯¹è¯ï¼Œéšè—å¿«æ·æé—®
      const hasHistory = chatHistory.length > 0 || currentSession !== null;
      const quickQuestions = document.getElementById('quickQuestions');
      
      if (hasHistory) {
        quickQuestions.style.display = 'none';
      } else {
        quickQuestions.style.display = 'block';
      }
    }

    // å¯¼å‡ºæ–‡æœ¬æ ¼å¼
    function exportText() {
      if (chatHistory.length === 0) {
        alert('æš‚æ— å†å²è®°å½•å¯å¯¼å‡º');
        return;
      }

      let textContent = 'æ™ºèƒ½åº—é“ºåŠ©æ‰‹ - å¯¹è¯è®°å½•\n';
      textContent += 'å¯¼å‡ºæ—¶é—´: ' + new Date().toLocaleString('zh-CN') + '\n';
      textContent += '=' * 50 + '\n\n';

      chatHistory.forEach((session, index) => {
        textContent += `å¯¹è¯ ${index + 1} (${new Date(session.timestamp).toLocaleString('zh-CN')})\n`;
        textContent += '-' * 30 + '\n';
        
        session.messages.forEach(message => {
          const sender = message.type === 'user' ? 'ç”¨æˆ·' : 'åŠ©æ‰‹';
          textContent += `[${sender}]: ${message.content}\n\n`;
        });
        
        textContent += '\n';
      });

      const blob = new Blob([textContent], { type: 'text/plain;charset=utf-8' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `æ™ºèƒ½åŠ©æ‰‹å¯¹è¯è®°å½•-${new Date().toISOString().split('T')[0]}.txt`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }

    // åˆå§‹åŒ–å†å²è®°å½•æ˜¾ç¤º
    function initHistory() {
      displayHistory();
    }

    // æ˜¾ç¤ºå†å²è®°å½•
    function displayHistory() {
      const historyList = document.getElementById('historyList');
      
      if (chatHistory.length === 0) {
        historyList.innerHTML = `
          <div class="empty-history">
            <div class="empty-history-icon">ğŸ’­</div>
            <div>æš‚æ— å†å²è®°å½•</div>
          </div>
        `;
        return;
      }

      historyList.innerHTML = chatHistory.map((session, index) => `
        <div class="history-item ${currentSession === index ? 'active' : ''}" 
             onclick="loadSession(${index})">
          <div class="history-question">${session.firstQuestion}</div>
          <div class="history-time">${formatTime(session.timestamp)}</div>
        </div>
      `).join('');
    }

    // æ ¼å¼åŒ–æ—¶é—´
    function formatTime(timestamp) {
      const date = new Date(timestamp);
      const now = new Date();
      const diffInMinutes = Math.floor((now - date) / (1000 * 60));
      
      if (diffInMinutes < 1) return 'åˆšåˆš';
      if (diffInMinutes < 60) return `${diffInMinutes}åˆ†é’Ÿå‰`;
      if (diffInMinutes < 1440) return `${Math.floor(diffInMinutes / 60)}å°æ—¶å‰`;
      if (diffInMinutes < 10080) return `${Math.floor(diffInMinutes / 1440)}å¤©å‰`;
      
      return date.toLocaleDateString('zh-CN', {
        month: 'short',
        day: 'numeric',
        hour: '2-digit',
        minute: '2-digit'
      });
    }

    // åˆ›å»ºæ–°çš„ä¼šè¯
    function createNewSession(question, response) {
      const newSession = {
        id: Date.now(),
        timestamp: Date.now(),
        firstQuestion: question.length > 30 ? question.substring(0, 30) + '...' : question,
        messages: [
          { type: 'user', content: question, timestamp: Date.now() },
          { type: 'bot', content: response, timestamp: Date.now() }
        ]
      };

      chatHistory.unshift(newSession);
      currentSession = 0;
      
      // é™åˆ¶å†å²è®°å½•æ•°é‡ï¼Œä¿æŒæœ€è¿‘50æ¡
      if (chatHistory.length > 50) {
        chatHistory = chatHistory.slice(0, 50);
      }
      
      localStorage.setItem('chatHistory', JSON.stringify(chatHistory));
      displayHistory();
      updateStats();
      hideQuickQuestions();
    }

    // æ·»åŠ æ¶ˆæ¯åˆ°å½“å‰ä¼šè¯
    function addToCurrentSession(type, content) {
      if (currentSession !== null && chatHistory[currentSession]) {
        chatHistory[currentSession].messages.push({
          type: type,
          content: content,
          timestamp: Date.now()
        });
        localStorage.setItem('chatHistory', JSON.stringify(chatHistory));
      }
    }

    // åŠ è½½ä¼šè¯
    function loadSession(sessionIndex) {
      if (sessionIndex >= 0 && sessionIndex < chatHistory.length) {
        const session = chatHistory[sessionIndex];
        currentSession = sessionIndex;
        
        // æ¸…ç©ºå½“å‰å¯¹è¯æ¡†
        const chatbox = document.getElementById("chatbox");
        chatbox.innerHTML = '';
        
        // åŠ è½½ä¼šè¯æ¶ˆæ¯
        session.messages.forEach(message => {
          if (message.type === 'user') {
            appendMessage('æ‚¨', message.content, 'user');
          } else {
            appendMessage('æ™ºèƒ½åŠ©æ‰‹', message.content, 'bot');
          }
        });
        
        displayHistory();
        scrollToBottom();
      }
    }

    // å¼€å¯æ–°å¯¹è¯
    function startNewChat() {
      // é‡ç½®å½“å‰ä¼šè¯çŠ¶æ€
      currentSession = null;
      
      // æ¸…ç©ºå¯¹è¯æ¡†
      const chatbox = document.getElementById("chatbox");
      chatbox.innerHTML = `
        <div class="message bot">
          <div class="message-header">
            <div class="avatar">ğŸ¤–</div>
            <span class="sender-name">æ™ºèƒ½åŠ©æ‰‹</span>
          </div>
          <div class="message-content">
            æ‚¨å¥½ï¼æˆ‘æ˜¯æ‚¨çš„æ™ºèƒ½åº—é“ºåŠ©æ‰‹ï¼Œå¯ä»¥ä¸ºæ‚¨æä¾›ï¼š<br>
            ğŸ“ åº—é“ºæ¨èä¸æœç´¢<br>
            ğŸ“Š å•†ä¸šæ•°æ®åˆ†æ<br>
            â­ ç”¨æˆ·è¯„ä»·è§£è¯»<br>
            ğŸ¯ ä¸ªæ€§åŒ–å»ºè®®<br><br>
            è¯·å‘Šè¯‰æˆ‘æ‚¨æƒ³äº†è§£ä»€ä¹ˆï¼Ÿ
          </div>
        </div>
      `;
      
      // é‡ç½®æ¶ˆæ¯è®¡æ•°
      messageCount = 0;
      
      // æ›´æ–°å†å²è®°å½•æ˜¾ç¤ºï¼ˆå–æ¶ˆå½“å‰ä¼šè¯çš„é«˜äº®ï¼‰
      displayHistory();
      
      // èšç„¦è¾“å…¥æ¡†
      document.getElementById("input").focus();
      
      // æ»šåŠ¨åˆ°åº•éƒ¨
      scrollToBottom();
    }

    // åˆ‡æ¢ä¾§è¾¹æ æ˜¾ç¤º
    function toggleSidebar() {
      const sidebar = document.getElementById('sidebar');
      const mainContent = document.querySelector('.main-content');
      const isVisible = sidebar.style.display !== 'none';
      
      if (isVisible) {
        sidebar.style.display = 'none';
        // å½“ä¾§è¾¹æ éšè—æ—¶ï¼Œç§»é™¤ä¸»å†…å®¹çš„å·¦è¾¹è·
        if (window.innerWidth > 768) {
          mainContent.style.paddingLeft = '20px';
        }
      } else {
        sidebar.style.display = 'flex';
        // å½“ä¾§è¾¹æ æ˜¾ç¤ºæ—¶ï¼Œæ¢å¤ä¸»å†…å®¹çš„å·¦è¾¹è·
        if (window.innerWidth > 1024) {
          mainContent.style.paddingLeft = '360px';
        } else if (window.innerWidth > 768) {
          mainContent.style.paddingLeft = '285px';
        }
      }
    }

    // æ¸…ç©ºå†å²è®°å½•
    function clearHistory() {
      if (confirm('ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰å†å²è®°å½•å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ã€‚')) {
        chatHistory = [];
        currentSession = null;
        localStorage.removeItem('chatHistory');
        displayHistory();
      }
    }

    // å¯¼å‡ºå†å²è®°å½•
    function exportHistory() {
      if (chatHistory.length === 0) {
        alert('æš‚æ— å†å²è®°å½•å¯å¯¼å‡º');
        return;
      }

      const exportData = {
        exportTime: new Date().toISOString(),
        totalSessions: chatHistory.length,
        sessions: chatHistory
      };

      const blob = new Blob([JSON.stringify(exportData, null, 2)], {
        type: 'application/json'
      });
      
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `chat-history-${new Date().toISOString().split('T')[0]}.json`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }

    async function send() {
      const input = document.getElementById("input");
      const msg = input.value.trim();
      
      if (!msg || isGenerating) return;

      // æ¸…ç†ä¹‹å‰çš„çŠ¶æ€
      if (currentTypewriterTimeout) {
        clearTimeout(currentTypewriterTimeout);
        currentTypewriterTimeout = null;
      }

      // åˆ›å»ºæ–°çš„AbortController
      currentAbortController = new AbortController();

      // ç¦ç”¨è¾“å…¥æ¡†å¹¶æ˜¾ç¤ºåœæ­¢æŒ‰é’®
      input.disabled = true;
      showStopButton();

      // æ·»åŠ ç”¨æˆ·æ¶ˆæ¯
      appendMessage("æ‚¨", msg, "user");
      input.value = "";

      // æ˜¾ç¤ºæ‰“å­—æŒ‡ç¤ºå™¨
      showTypingIndicator();

      try {
        const res = await fetch("/chat", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ message: msg }),
          signal: currentAbortController.signal // æ·»åŠ ä¸­æ–­ä¿¡å·
        });

        if (!res.ok) {
          throw new Error(`HTTP ${res.status}: ${res.statusText}`);
        }

        const data = await res.json();
        
        // æ£€æŸ¥æ˜¯å¦è¢«ä¸­æ–­
        if (currentAbortController.signal.aborted || !isGenerating) {
          return;
        }
        
        // éšè—æ‰“å­—æŒ‡ç¤ºå™¨
        hideTypingIndicator();
        
        // æ¨¡æ‹Ÿæ‰“å­—æ•ˆæœ
        try {
          await typeWriterEffect("æ™ºèƒ½åŠ©æ‰‹", data.response || "æŠ±æ­‰ï¼Œæˆ‘æ²¡æœ‰ç†è§£æ‚¨çš„é—®é¢˜ã€‚", "bot");
          
          // æ‰“å­—æ•ˆæœå®Œæˆåæ‰ä¿å­˜åˆ°å†å²è®°å½•
          if (currentSession === null) {
            // åˆ›å»ºæ–°ä¼šè¯
            createNewSession(msg, data.response || "æŠ±æ­‰ï¼Œæˆ‘æ²¡æœ‰ç†è§£æ‚¨çš„é—®é¢˜ã€‚");
          } else {
            // æ·»åŠ åˆ°å½“å‰ä¼šè¯
            addToCurrentSession('user', msg);
            addToCurrentSession('bot', data.response || "æŠ±æ­‰ï¼Œæˆ‘æ²¡æœ‰ç†è§£æ‚¨çš„é—®é¢˜ã€‚");
          }
        } catch (typeError) {
          // æ‰“å­—æ•ˆæœè¢«ä¸­æ–­ï¼Œä¸ä¿å­˜åˆ°å†å²è®°å½•
          console.log('æ‰“å­—æ•ˆæœè¢«ç”¨æˆ·ä¸­æ–­');
        }
        
      } catch (error) {
        // æ£€æŸ¥æ˜¯å¦æ˜¯ç”¨æˆ·ä¸»åŠ¨ä¸­æ–­
        if (error.name === 'AbortError') {
          return; // ç”¨æˆ·ä¸­æ–­ï¼Œä¸æ˜¾ç¤ºé”™è¯¯
        }
        
        hideTypingIndicator();
        const errorMsg = `è¿æ¥å¤±è´¥: ${error.message}`;
        appendMessage("ç³»ç»Ÿ", errorMsg, "bot");
        
        // ä¹Ÿä¿å­˜é”™è¯¯æ¶ˆæ¯åˆ°å†å²
        if (currentSession === null) {
          createNewSession(msg, errorMsg);
        } else {
          addToCurrentSession('user', msg);
          addToCurrentSession('bot', errorMsg);
        }
      } finally {
        // é‡æ–°å¯ç”¨è¾“å…¥æ¡†å¹¶éšè—åœæ­¢æŒ‰é’®
        hideStopButton();
        input.disabled = false;
        input.focus();
        currentAbortController = null;
      }
    }

    function appendMessage(sender, text, cls) {
      const box = document.getElementById("chatbox");
      const messageDiv = document.createElement("div");
      messageDiv.className = `message ${cls}`;
      
      messageDiv.innerHTML = `
        <div class="message-header">
          <div class="avatar">${cls === 'user' ? 'ğŸ‘¤' : 'ğŸ¤–'}</div>
          <span class="sender-name">${sender}</span>
        </div>
        <div class="message-content" style="position: relative;">
          ${formatMessage(text)}
        </div>
      `;
      
      box.appendChild(messageDiv);
      scrollToBottom();
      messageCount++;
      hideQuickQuestions();
    }

    async function typeWriterEffect(sender, text, cls) {
      const box = document.getElementById("chatbox");
      const messageDiv = document.createElement("div");
      messageDiv.className = `message ${cls}`;
      
      messageDiv.innerHTML = `
        <div class="message-header">
          <div class="avatar">${cls === 'user' ? 'ğŸ‘¤' : 'ğŸ¤–'}</div>
          <span class="sender-name">${sender}</span>
        </div>
        <div class="message-content"></div>
      `;
      
      box.appendChild(messageDiv);
      const contentDiv = messageDiv.querySelector('.message-content');
      
      // æ‰“å­—æ•ˆæœ
      const formattedText = formatMessage(text);
      let i = 0;
      const tempDiv = document.createElement('div');
      tempDiv.innerHTML = formattedText;
      const plainText = tempDiv.textContent || tempDiv.innerText;
      
      return new Promise((resolve, reject) => {
        function typeChar() {
          // æ£€æŸ¥æ˜¯å¦è¢«ä¸­æ–­
          if (!isGenerating || (currentAbortController && currentAbortController.signal.aborted)) {
            // è¢«ä¸­æ–­æ—¶ç§»é™¤æœªå®Œæˆçš„æ¶ˆæ¯
            if (currentTypewriterTimeout) {
              clearTimeout(currentTypewriterTimeout);
              currentTypewriterTimeout = null;
            }
            // ç§»é™¤æœªå®Œæˆçš„æ¶ˆæ¯å…ƒç´ 
            if (messageDiv && messageDiv.parentNode) {
              messageDiv.parentNode.removeChild(messageDiv);
            }
            reject(new Error('Typing interrupted'));
            return;
          }
          
          if (i < plainText.length) {
            contentDiv.textContent = plainText.substring(0, i + 1);
            i++;
            scrollToBottom();
            currentTypewriterTimeout = setTimeout(typeChar, 30); // ä¿å­˜è¶…æ—¶å¼•ç”¨
          } else {
            // æ‰“å­—å®Œæˆåæ˜¾ç¤ºæ ¼å¼åŒ–å†…å®¹
            contentDiv.innerHTML = formattedText;
            scrollToBottom();
            currentTypewriterTimeout = null;
            resolve();
          }
        }
        
        typeChar();
      });
    }

    function formatMessage(text) {
      // ç®€å•çš„æ–‡æœ¬æ ¼å¼åŒ–
      return text
        .replace(/\n/g, '<br>')
        .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
        .replace(/\*(.*?)\*/g, '<em>$1</em>')
        .replace(/(https?:\/\/[^\s]+)/g, '<a href="$1" target="_blank">$1</a>');
    }

    function showTypingIndicator() {
      const chatbox = document.getElementById("chatbox");
      const typingMessage = document.createElement("div");
      typingMessage.className = "message bot typing-message";
      typingMessage.id = "typingIndicator";
      typingMessage.innerHTML = `
        <div class="message-header">
          <div class="avatar">ğŸ¤–</div>
          <span class="sender-name">æ™ºèƒ½åŠ©æ‰‹</span>
        </div>
        <div class="message-content typing-content">
          <div class="typing-dots">
            <div class="typing-dot"></div>
            <div class="typing-dot"></div>
            <div class="typing-dot"></div>
          </div>
        </div>
      `;
      chatbox.appendChild(typingMessage);
      scrollToBottom();
    }

    function hideTypingIndicator() {
      const typingIndicator = document.getElementById("typingIndicator");
      if (typingIndicator) {
        typingIndicator.remove();
      }
    }

    function scrollToBottom() {
      const chatbox = document.getElementById("chatbox");
      chatbox.scrollTop = chatbox.scrollHeight;
    }

    async function clearChat() {
      if (confirm("ç¡®å®šè¦æ¸…ç©ºå½“å‰å¯¹è¯å—ï¼Ÿ")) {
        try {
          const res = await fetch("/reset", {
            method: "POST",
            headers: { "Content-Type": "application/json" }
          });
          
          if (res.ok) {
            const chatbox = document.getElementById("chatbox");
            chatbox.innerHTML = `
              <div class="message bot">
                <div class="message-header">
                  <div class="avatar">ğŸ¤–</div>
                  <span class="sender-name">æ™ºèƒ½åŠ©æ‰‹</span>
                </div>
                <div class="message-content">
                  å¯¹è¯å·²æ¸…ç©ºï¼æˆ‘æ˜¯æ‚¨çš„æ™ºèƒ½åº—é“ºåŠ©æ‰‹ï¼Œå¯ä»¥ä¸ºæ‚¨æä¾›ï¼š<br>
                  ğŸ“ åº—é“ºæ¨èä¸æœç´¢<br>
                  ğŸ“Š å•†ä¸šæ•°æ®åˆ†æ<br>
                  â­ ç”¨æˆ·è¯„ä»·è§£è¯»<br>
                  ğŸ¯ ä¸ªæ€§åŒ–å»ºè®®<br><br>
                  è¯·å‘Šè¯‰æˆ‘æ‚¨æƒ³äº†è§£ä»€ä¹ˆï¼Ÿ
                </div>
              </div>
            `;
            messageCount = 0;
            currentSession = null; // é‡ç½®å½“å‰ä¼šè¯
            displayHistory(); // æ›´æ–°å†å²è®°å½•æ˜¾ç¤º
          }
        } catch (error) {
          alert("æ¸…ç©ºå¯¹è¯å¤±è´¥ï¼Œè¯·é‡è¯•");
        }
      }
    }

    // å›è½¦å‘é€
    document.getElementById("input").addEventListener("keypress", function(e) {
      if (e.key === "Enter" && !e.shiftKey && !isGenerating) {
        e.preventDefault();
        send();
      }
    });

    // é¡µé¢åŠ è½½å®Œæˆåèšç„¦è¾“å…¥æ¡†å’Œåˆå§‹åŒ–å†å²è®°å½•
    window.addEventListener('load', function() {
      document.getElementById("input").focus();
      initializePage();
    });

    // é˜²æ­¢é¡µé¢åˆ·æ–°æ—¶ä¸¢å¤±ç„¦ç‚¹
    window.addEventListener('beforeunload', function() {
      return null;
    });

    // ç›‘å¬çª—å£å¤§å°å˜åŒ–ï¼Œè°ƒæ•´å¸ƒå±€
    window.addEventListener('resize', function() {
      const sidebar = document.getElementById('sidebar');
      const rightSidebar = document.querySelector('.right-sidebar');
      const mainContent = document.querySelector('.main-content');
      const toggleBtn = document.querySelector('.toggle-sidebar');
      
      if (window.innerWidth <= 768) {
        // ç§»åŠ¨ç«¯ï¼šä¾§è¾¹æ ä½¿ç”¨ç›¸å¯¹å®šä½
        sidebar.style.position = 'relative';
        sidebar.style.top = 'auto';
        sidebar.style.left = 'auto';
        sidebar.style.bottom = 'auto';
        rightSidebar.style.position = 'relative';
        rightSidebar.style.top = 'auto';
        rightSidebar.style.right = 'auto';
        rightSidebar.style.bottom = 'auto';
        mainContent.style.paddingLeft = '10px';
        mainContent.style.paddingRight = '10px';
        mainContent.style.paddingTop = '80px';
        mainContent.style.gap = '10px'; /* ç§»åŠ¨ç«¯ä¿æŒå°é—´è· */
        toggleBtn.style.display = 'flex';
        toggleBtn.style.left = '20px';
      } else {
        // æ¡Œé¢ç«¯ï¼šä¾§è¾¹æ ä½¿ç”¨å›ºå®šå®šä½
        sidebar.style.position = 'fixed';
        sidebar.style.left = '20px';
        sidebar.style.bottom = '20px';
        rightSidebar.style.position = 'fixed';
        rightSidebar.style.right = '20px';
        rightSidebar.style.bottom = '20px';
        mainContent.style.paddingTop = '20px';
        mainContent.style.gap = '0'; /* æ¡Œé¢ç«¯æ— é—´è·ï¼Œæœ€å¤§åŒ–å®½åº¦ */
        toggleBtn.style.display = 'none';
        
        // æ ¹æ®å±å¹•å®½åº¦è°ƒæ•´ä¸»å†…å®¹è¾¹è·å’Œä¾§è¾¹æ ä½ç½®
        if (sidebar.style.display !== 'none') {
          if (window.innerWidth > 1024) {
            sidebar.style.top = '140px';
            sidebar.style.width = '300px';
            sidebar.style.left = '20px';
            rightSidebar.style.top = '140px';
            rightSidebar.style.width = '280px';
            rightSidebar.style.right = '20px';
            mainContent.style.paddingLeft = '340px';
            mainContent.style.paddingRight = '320px';
            toggleBtn.style.left = '320px';
          } else {
            sidebar.style.top = '80px';
            sidebar.style.width = '250px'; 
            sidebar.style.left = '15px';
            rightSidebar.style.top = '80px';
            rightSidebar.style.width = '240px';
            rightSidebar.style.right = '15px';
            mainContent.style.paddingLeft = '285px';
            mainContent.style.paddingRight = '270px';
            toggleBtn.style.left = '275px';
          }
        } else {
          mainContent.style.paddingLeft = '20px';
          mainContent.style.paddingRight = '320px';
        }
      }
    });

    // æ˜¾ç¤ºå¸®åŠ©ä¿¡æ¯
    function showHelp() {
      alert(`ğŸ”§ ä½¿ç”¨å¸®åŠ©

ğŸ“ åŸºæœ¬æ“ä½œï¼š
â€¢ åœ¨è¾“å…¥æ¡†ä¸­è¾“å…¥é—®é¢˜ï¼Œç‚¹å‡»å‘é€æˆ–æŒ‰å›è½¦é”®
â€¢ ç‚¹å‡»è¯­éŸ³æŒ‰é’®(ğŸ¤)è¿›è¡Œè¯­éŸ³è¾“å…¥
â€¢ ä½¿ç”¨å¿«æ·æé—®æŒ‰é’®å¿«é€Ÿæé—®

ğŸ¨ ä¸ªæ€§åŒ–è®¾ç½®ï¼š
â€¢ ğŸŒ“ åˆ‡æ¢æ—¥é—´/å¤œé—´ä¸»é¢˜
â€¢ ğŸ”/ğŸ” è°ƒæ•´å­—ä½“å¤§å°
â€¢ ğŸ” æœç´¢å†å²å¯¹è¯è®°å½•

ğŸ“Š æ•°æ®ç®¡ç†ï¼š
â€¢ ğŸ“„ å¯¼å‡ºå¯¹è¯è®°å½•ä¸ºæ–‡æœ¬æ ¼å¼
â€¢ ğŸ’¾ å¯¼å‡ºå¯¹è¯è®°å½•ä¸ºJSONæ ¼å¼
â€¢ ğŸ“Š æŸ¥çœ‹ä½¿ç”¨ç»Ÿè®¡ä¿¡æ¯

ğŸ’¡ æç¤ºï¼š
â€¢ æ‰€æœ‰è®¾ç½®ä¼šè‡ªåŠ¨ä¿å­˜åˆ°æœ¬åœ°
â€¢ æ”¯æŒå¤šè½®å¯¹è¯ï¼ŒAIä¼šè®°ä½ä¸Šä¸‹æ–‡
â€¢ ç§»åŠ¨ç«¯å’Œæ¡Œé¢ç«¯å‡å®Œå…¨æ”¯æŒ`);
    }

    // æ˜¾ç¤ºå…³äºä¿¡æ¯
    function showAbout() {
      alert(`â„¹ï¸ å…³äºæ™ºèƒ½åº—é“ºåŠ©æ‰‹

ğŸª äº§å“ä»‹ç»ï¼š
åŸºäºRAGæŠ€æœ¯çš„å•†æˆ·æ¨èä¸åˆ†æä¸“å®¶ç³»ç»Ÿï¼Œä¸ºç”¨æˆ·æä¾›ç²¾å‡†çš„å•†ä¸šä¿¡æ¯æŸ¥è¯¢å’Œæ•°æ®åˆ†ææœåŠ¡ã€‚

âœ¨ æ ¸å¿ƒåŠŸèƒ½ï¼š
â€¢ ğŸ“ æ™ºèƒ½åº—é“ºæ¨è
â€¢ ğŸ“Š å•†ä¸šæ•°æ®åˆ†æ
â€¢ â­ ç”¨æˆ·è¯„ä»·è§£è¯»
â€¢ ğŸ¯ ä¸ªæ€§åŒ–å»ºè®®ç”Ÿæˆ

ğŸ”§ æŠ€æœ¯ç‰¹è‰²ï¼š
â€¢ RAGæ£€ç´¢å¢å¼ºç”ŸæˆæŠ€æœ¯
â€¢ å®æ—¶æ•°æ®å¤„ç†ä¸åˆ†æ
â€¢ å¤šæ¨¡æ€äº¤äº’ä½“éªŒ
â€¢ å“åº”å¼ç•Œé¢è®¾è®¡

ğŸ“§ è”ç³»æˆ‘ä»¬ï¼š
å¦‚æœ‰é—®é¢˜æˆ–å»ºè®®ï¼Œæ¬¢è¿åé¦ˆï¼

ç‰ˆæœ¬ï¼šv2.0 
æ›´æ–°æ—¶é—´ï¼š${new Date().toLocaleDateString('zh-CN')}`);
    }

    // æ»šåŠ¨åˆ°é¡¶éƒ¨
    function scrollToTop() {
      const chatbox = document.getElementById("chatbox");
      chatbox.scrollTo({ top: 0, behavior: 'smooth' });
    }

    // æ»šåŠ¨åˆ°åº•éƒ¨ï¼ˆå·²æœ‰å‡½æ•°ï¼Œä½†ä¸ºäº†å®Œæ•´æ€§é‡æ–°å®šä¹‰ï¼‰
    function scrollToBottomSmooth() {
      const chatbox = document.getElementById("chatbox");
      chatbox.scrollTo({ top: chatbox.scrollHeight, behavior: 'smooth' });
    }

    // å…¨å±æ¨¡å¼åˆ‡æ¢
    function toggleFullscreen() {
      if (!document.fullscreenElement) {
        document.documentElement.requestFullscreen().catch(err => {
          alert('æ— æ³•è¿›å…¥å…¨å±æ¨¡å¼: ' + err.message);
        });
      } else {
        document.exitFullscreen();
      }
    }
  </script>
</body>
</html>
